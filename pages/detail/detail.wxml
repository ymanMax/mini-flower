<wxs module="filter" src="../../utils/index.wxs" module="utils"></wxs>

<swiper class="datail-swiper" indicator-dots="true" autoplay="true" interval="5000" duration="300" circular='true'>
  <block wx:for="{{goodsInfo.imgUrls}}" wx:key="*this">
    <swiper-item class="wp-100">
      <image src="{{item}}" class="wp-100" mode="widthFix" />
    </swiper-item>
  </block>
</swiper>

<view class="datail-info">
  <view class="goods-title bc-fff ">
    <view class="fs-15">{{goodsInfo.ad}}</view>
    <view class="fs-12 fc-666">{{goodsInfo.flowerLanguage}}</view>

    <view class="price fs-12">
      <text>￥</text>
      <text class="curr-price fs-18">{{goodsInfo.price}}</text>
      <text class="origin-price ml-5">￥{{goodsInfo.originPrice}}</text>
    </view>
    <view class='fs-12 mt-5 fc-666'>销量：{{utils.formatSaleNum(goodsInfo.saleNum)}} 万件</view>
  </view>

  <view class="coupons mt-10 fs-12 fc-666 flex jc-sb">
    <view>领券</view>
    <van-icon name="arrow" />
  </view>

  <view class="distribution fs-12 mt-10">
    <view class="flex jc-sb">
      <view>
        <text class="fc-666">选择</text>
        <text class="ml-10">请选择规格</text>
      </view>
      <van-icon name="arrow" />
    </view>
    <view class="flex jc-sb mt-10">
      <view>
        <text class="fc-666">保障</text>
        <text class="ml-10">全国配送·新鲜保障·图片回传·1-3小时送达</text>
      </view>
      <van-icon name="arrow" />
    </view>
  </view>

  <view class="evaluate mt-10 fs-12 fc-666">
    <view class="evaluate-title flex jc-sb">
      <text>评价</text>
      <view>
        <van-button size="small" type="primary" bindtap="openCommentModal">
          写评价
        </van-button>
      </view>
    </view>

    <view class="evaluate-box">
      <view
        wx:for="{{comments}}"
        wx:key="commentId"
        class="evaluate"
      >
        <view class="user-info flex jc-sb ai-c">
          <view class=" flex ai-c">
            <image src="{{item.userAvatar || '../../img/my.png'}}" />
            <text class="ml-15">{{item.userNickname}}</text>
          </view>
          <text>{{item.createTime}}</text>
        </view>
        <view class="mt-5">
          <van-rate value="{{item.score}}" disabled size="20" />
        </view>
        <view class="fc-000 fs-16 mt-10">{{item.content}}</view>
        <view class="phone-img mt-10" wx:if="{{item.imgUrls && item.imgUrls.length > 0}}">
          <image
            wx:for="{{item.imgUrls}}"
            wx:key="*this"
            src="{{item}}"
          />
        </view>
        <view class="like-btn mt-10 flex ai-c" bindtap="likeComment" data-commentid="{{item.commentId}}">
          <van-icon name="good-job-o" size="20" />
          <text class="ml-5">点赞</text>
        </view>
      </view>

      <view wx:if="{{comments.length === 0}}" class="empty-comments">
        <van-icon name="comment-o" size="60" color="#ccc" />
        <text>暂无评价，快来发表第一个评价吧！</text>
      </view>
    </view>
  </view>
</view>

<van-goods-action class="footer">
  <van-goods-action-icon icon="chat-o" text="客服" />
  <van-goods-action-icon icon="share-o" text="分享" bindtap="shareGoods" />
  <navigator url="/pages/cart/cart" open-type="switchTab">
    <van-goods-action-icon class="cart" icon="cart-o" text="购物车" info="{{cartGoodsListAllNum}}" />
  </navigator>
  <van-goods-action-icon icon="shop-o" text="店铺" />
  <van-goods-action-button type="warning" bindtap="addCart" text="加入购物车" />
  <van-goods-action-button type="danger" text="立即购买" />
</van-goods-action>

<!-- 评价提交弹窗 -->
<van-popup
  show="{{showCommentModal}}"
  position="bottom"
  round
  custom-style="height: 80%"
  bind:close="closeCommentModal"
>
  <view class="comment-modal">
    <view class="modal-header">
      <text class="modal-title">发表评价</text>
      <van-icon name="cross" size="24" bindtap="closeCommentModal" />
    </view>

    <view class="modal-content">
      <!-- 评分选择 -->
      <view class="score-section">
        <text class="section-title">商品评分</text>
        <van-rate value="{{commentScore}}" bind:change="onCommentScoreChange" size="30" />
      </view>

      <!-- 评价内容 -->
      <view class="content-section">
        <text class="section-title">评价内容</text>
        <van-field
          value="{{commentContent}}"
          placeholder="请输入您的评价"
          border="none"
          textarea
          rows="4"
          maxlength="500"
          bind:input="onCommentContentInput"
        />
      </view>

      <!-- 评价图片 -->
      <view class="image-section">
        <text class="section-title">上传图片</text>
        <view class="image-list">
          <view
            wx:for="{{commentImages}}"
            wx:key="*this"
            class="image-item"
          >
            <image src="{{item}}" mode="aspectFill" />
            <van-icon
              name="cross"
              size="16"
              class="delete-icon"
              bindtap="deleteCommentImage"
              data-index="{{index}}"
            />
          </view>
          <view
            wx:if="{{commentImages.length < 4}}"
            class="add-image"
            bindtap="chooseCommentImages"
          >
            <van-icon name="plus" size="30" />
          </view>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <van-button size="large" type="primary" bindtap="submitComment">
        提交评价
      </van-button>
    </view>
  </view>
</van-popup>